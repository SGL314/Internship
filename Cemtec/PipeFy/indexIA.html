<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KanBan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fa;
      margin: 0;
    }
    .kanban-board {
      display: flex;
      gap: 20px;
      padding: 40px;
    }
    .kanban-column {
      background: #fff;
      border-radius: 8px;
      border: 2px solid black;
      box-shadow: 0 2px 8px #0001;
      width: 300px;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    .kanban-column h2 {
      margin: 0 0 12px 0;
      font-size: 1.2em;
    }
    .kanban-cards {
      flex: 1;
      min-height: 40px;
    }
    .kanban-card {
      background: #e3e7ef;
      border: 2px solid #4f8cff;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      transition: border 0.2s;
    }
    .kanban-card[data-drop-position="before"] {
      border-top: 12px solid #4f8cff;
      /*border-top: 12px solid #ff874f;*/
    }
    .kanban-card[data-drop-position="after"] {
      border-bottom: 12px solid #4f8cff;
    }
    .kanban-actions button {
      margin-left: 4px;
      background: #d1d8e6;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 2px 6px;
    }
    .add-task-form {
      display: flex;
      margin-top: 12px;
    }
    .add-task-form input {
      flex: 1;
      padding: 4px;
    }
    .add-task-form button {
      margin-left: 4px;
    }
    #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: #0005;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #editModal .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 24px 32px;
      min-width: 300px;
      box-shadow: 0 4px 24px #0003;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }
    #editModal .modal-content button.close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="editModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeEditModal()">&times;</button>
      <h3>Editar tarefa</h3>
      <input id="editInput" type="text" />
      <button onclick="saveEdit()" style="padding:8px; background:#4f8cff; color:#fff; border:none; border-radius:4px; font-size:1em; cursor:pointer;">Salvar</button>
    </div>
  </div>

  <div class="kanban-board" id="kanbanBoard"></div>

  <script>
    const columns = [
      { name: "A Fazer", id: "todo" },
      { name: "Em Progresso", id: "doing" },
      { name: "Conclu√≠do", id: "done" }
    ];

    let tasks = [ {id:"1", title: "a", index:0, column: "todo"},
                  {id:"2", title: "b", index:1, column: "todo"},
                  {id:"3", title: "c", index:2, column: "todo"},
                  {id:"4", title: "d", index:3, column: "todo"},
                  {id:"5", title: "e", index:4, column: "todo"}
    ];
    let dragTaskId = null;
    let editingTaskId = null;

    function renderBoard() {
      orderTasks();
      const board = document.getElementById("kanbanBoard");
      board.innerHTML = "";

      columns.forEach(col => {
        const colDiv = document.createElement("div");
        colDiv.className = "kanban-column";
        colDiv.innerHTML = `
          <h2>${col.name}</h2>
          <div class="kanban-cards" id="cards-${col.id}"
            ondragover="event.preventDefault()"
            ondrop="onDropColumn('${col.id}')"></div>
          <form class="add-task-form" onsubmit="addTask(event, '${col.id}')">
            <input type="text" placeholder="Nova tarefa..." required>
            <button type="submit">+</button>
          </form>
        `;
        board.appendChild(colDiv);

        const cardsDiv = colDiv.querySelector(".kanban-cards");
        var colTasks = tasks.filter(t => t.column === col.id);
        var nova = [];
        //console.log("preset:");
        colTasks.forEach(function (t) {
          nova.push(t);
        });
        colTasks = [];
        nova.forEach(function (t) {
          colTasks.push(t);
          //console.log(t.index);
        });
        //console.log("appr:");

        colTasks.forEach(task => {
          const card = document.createElement("div");
          card.className = "kanban-card";
          card.draggable = true;
          card.dataset.id = task.id;
          console.log(task.index);

          card.ondragstart = e => {
            dragTaskId = task.id;
            card.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          };

          card.ondragend = () => {
            dragTaskId = null;
            card.classList.remove("dragging");
            clearDropIndicators();
          };

          card.ondragover = e => {
            e.preventDefault();
            setDropIndicator(card, e);
          };

          card.ondragleave = () => {
            card.removeAttribute("data-drop-position");
          };

          card.ondrop = e => {
            e.preventDefault();
            handleDropOnCard(task.id, col.id, e);
          };

          card.innerHTML = `
            <span class="span-moving" data-id="${task.id}">${task.title}</span>
            <span class="kanban-actions">
              <button onclick="editTask(${task.id})">‚úèÔ∏è</button>
              <button onclick="removeTask(${task.id})">üóëÔ∏è</button>
            </span>
          `;

          cardsDiv.appendChild(card);
        });
      });
    }

    function orderTasks() {
        var nova = [];
        var ind = tasks.reduce((a,b) => a.index < b.index ? a : b).index;
        console.log(tasks);
        var run = 1;
        while (nova.length != tasks.length) {
            for (var t of tasks) {
                if (parseInt(t.index) == ind) {
                    nova.push(t);
                    console.log(ind);
                    nova.forEach(function (t) {
                        console.log(t);
                    });
                    break;
                }
            }
            <!-- console.log("run : "+run); -->
            run++;
            
            ind ++;
        }
        tasks = []; 
        nova.forEach(function (t) {
            tasks.push(t);
        });
        tasks.forEach(function (t) {
            console.log(t);
        });
        for (var t in tasks){
            tasks[t].index = parseInt(t);
        }
    }

    function setDropIndicator(card, e) {
      const bounding = card.getBoundingClientRect();
      const offset = e.clientY - bounding.top;
      const height = bounding.height;

      if (offset < height / 2) {
        card.dataset.dropPosition = "before";
      } else {
        card.dataset.dropPosition = "after";
      }
    }

    function clearDropIndicators() {
      document.querySelectorAll('.kanban-card').forEach(card => {
        card.removeAttribute("data-drop-position");
      });
    }

    function handleDropOnCard(targetId, columnId, e) {
        if (dragTaskId === null || dragTaskId === targetId) return;

        const dragIdx = tasks.findIndex(t => t.id.toString() === dragTaskId.toString());
        const targetIdx = tasks.findIndex(t => t.id.toString() === targetId.toString());
        const dragged = tasks[dragIdx];
        const dropPosition = e.currentTarget.dataset.dropPosition;

        // Remove da posi√ß√£o original
        tasks.splice(dragIdx, 1);

        // Atualiza a coluna
        dragged.column = columnId;

        // Recalcula tarefas da coluna destino (depois do splice acima)
        const colTasks = tasks.filter(t => t.column === columnId);
        const newTargetIdx = colTasks.findIndex(t => t.id.toString() === targetId.toString());

        let insertIdx = newTargetIdx;
        if (dropPosition === "after") insertIdx+=1;
        else insertIdx--;

        // Encontra o √≠ndice global onde inserir
        dragged.index = insertIdx;
        console.log("dragged index: " + dragged.index);

        // altera os q vem depois
        tasks.forEach(t => {
            console.log(t);
        });
        for (var t of tasks){
            if (t.index > insertIdx) {
                t.index++;
            }
            if (t.index <= insertIdx){
                t.index--;
            }
        }
        tasks.push(dragged);
        // organiza
      //  for (var t in tasks){
         //  tasks[t].index = parseInt(t);
      // }
        // ordena
        
        //orderTasks();
        renderBoard();
    }


    function onDropColumn(columnId) {
      if (dragTaskId !== null) {
        const dragIdx = tasks.findIndex(t => t.id === dragTaskId);
        const dragged = tasks[dragIdx];
        tasks.splice(dragIdx, 1);
        dragged.column = columnId;
        tasks.push(dragged);
        renderBoard();
      }
    }

    function addTask(event, columnId) {
      event.preventDefault();
      const input = event.target.querySelector("input");
      var newTask = {
        id: String(Date.now()) + Math.random().toString(36).substring(2, 6),
        title: input.value,
        index: tasks.filter(t => t.column === columnId).length,
        column: columnId
      };
      tasks.push(newTask);
      console.log(newTask);
      input.value = "";
      renderBoard();
    }

    function editTask(id) {
      const task = tasks.find(t => t.id === id);
      editingTaskId = id;
      document.getElementById("editInput").value = task.title;
      document.getElementById("editModal").style.display = "flex";
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
      editingTaskId = null;
    }

    function saveEdit() {
      const newTitle = document.getElementById("editInput").value.trim();
      if (newTitle && editingTaskId !== null) {
        const task = tasks.find(t => t.id === editingTaskId);
        task.title = newTitle;
        renderBoard();
        closeEditModal();
      }
    }

    renderBoard();
  </script>
</body>
</html>
