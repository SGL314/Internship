<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KanBan</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #f4f6fa; 
            margin: 0; 
        }
        .kanban-board { 
            display: flex; 
            gap: 20px; 
            padding: 40px; 
        }
        .kanban-column {
            background: #fff;
            border-radius: 8px;
            border: 2px solid black;
            box-shadow: 0 2px 8px #0001;
            width: 300px;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .kanban-column h2 { 
            margin: 0 0 12px 0; 
            font-size: 1.2em; 
        }
        .kanban-cards { 
            flex: 1; 
            min-height: 40px; 
        }
        .kanban-card {
            background: #e3e7ef;
            border: 2px solid #4f8cff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
        }
        .kanban-card.dragging { 
            opacity: 1; 
        }
        .kanban-actions button {
            margin-left: 4px;
            background: #d1d8e6;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 6px;
        }
        .add-task-form { 
            display: flex; 
            margin-top: 12px; 
        }
        .add-task-form input { 
            flex: 1; 
            padding: 4px; 
        }
        .add-task-form button { 
            margin-left: 4px; 
        }
    </style>
</head>
<body>
    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0005; align-items:center; justify-content:center; z-index:1000;">
        <div style="background:#fff; border-radius:8px; padding:24px 32px; min-width:300px; box-shadow:0 4px 24px #0003; display:flex; flex-direction:column; gap:16px; position:relative;">
            <button onclick="closeEditModal()" style="position:absolute; top:8px; right:8px; background:none; border:none; font-size:1.2em; cursor:pointer;">&times;</button>
            <h3>Editar tarefa</h3>
            <input id="editInput" type="text" style="padding:8px; font-size:1em;">
            <button onclick="saveEdit()" style="padding:8px; background:#4f8cff; color:#fff; border:none; border-radius:4px; font-size:1em; cursor:pointer;">Salvar</button>
        </div>
    </div>
    <div class="kanban-board" id="kanbanBoard"></div>
    <script>
        const columns = [
            { name: "A Fazer", id: "todo" },
            { name: "Em Progresso", id: "doing" },
            { name: "Conclu√≠do", id: "done" }
        ];

        let tasks = [
            
        ];

        let dragTaskId = null;

        function renderBoard() {
            orderTasks();
            const board = document.getElementById('kanbanBoard');
            board.innerHTML = '';
            columns.forEach(col => {
                const colDiv = document.createElement('div');
                colDiv.className = 'kanban-column';
                colDiv.innerHTML = `<h2>${col.name}</h2>
                    <div class="kanban-cards" id="cards-${col.id}" 
                        ondragover="event.preventDefault()" 
                        ondrop="onDropColumn('${col.id}')"></div>
                    <form class="add-task-form" onsubmit="addTask(event, '${col.id}')">
                        <input type="text" placeholder="Nova tarefa..." required>
                        <button type="submit">+</button>
                    </form>`;
                board.appendChild(colDiv);

                const cardsDiv = colDiv.querySelector('.kanban-cards');
                const colTasks = tasks.filter(t => t.column === col.id);
                colTasks.forEach((task, idx) => {
                    const card = document.createElement('div');
                    card.className = 'kanban-card';
                    card.dataset.id = task.id;
                    card.draggable = true;
                    card.ondragstart = (e) => {
                        dragTaskId = task.id;
                        card.classList.add('dragging');
                        e.dataTransfer.effectAllowed = "move";
                    };
                    card.ondragend = () => {
                        dragTaskId = null;
                        card.classList.remove('dragging');
                        clearDropIndicators();
                    };
                    card.ondragover = (e) => {
                        e.preventDefault();
                        setDropIndicator(card, e);
                    };
                    card.ondragleave = () => {
                        card.style.borderTop = "";
                        card.style.borderBottom = "";
                    };
                    card.ondrop = (e) => {
                        e.preventDefault();
                        card.style.borderTop = "";
                        card.style.borderBottom = "";
                        handleDropOnCard(task.id, col.id, e);
                    };
                    
                    cardsDiv.appendChild(card);
                    
                    editPossTask(task.id);
                    
                    card.innerHTML = `
                        <span class="span-moving" data-id="${task.id}">${task.title} : (${task.x},${task.y})</span>
                        <span class="kanban-actions">
                            <button onclick="editTask(${task.id})" title="Editar">‚úèÔ∏è</button>
                            <button onclick="removeTask(${task.id})" title="Remover">üóëÔ∏è</button>
                        </span>
                    `;

                    // listener da posi√ß√£o
                    card.addEventListener('dragover', () => {
                        editPossTask(task.id);
                        document.querySelector(`.span-moving[data-id="${task.id}"]`).innerHTML = `${task.title} : (${task.x},${task.y})`;
                        console.log(`movendo: ${task.id} ${document.querySelector(`.span-moving[data-id="${task.id}"]`).innerHTML}`);
                        // console.log(`Card ${task.id} clicked at position (${task.x}, ${task.y})`);
                    });
                    
                });
            });
        }

        function orderTasks() {
            columns.forEach(col => {
                tasks
                    .filter(t => t.column === col.id)
                    .sort((a, b) => a.index - b.index)
                    .forEach((t, idx) => t.index = idx);
            });
        }

        // Adiciona indicador visual de onde ser√° inserido (antes ou depois do card)
        function setDropIndicator(card, e) {
            const bounding = card.getBoundingClientRect();
            const offset = e.clientY - bounding.top;
            const height = bounding.height;
            if (offset < height / 2) {
                card.style.borderTop = "3px solid #4f8cff";
                card.style.borderBottom = "";
                card.dataset.dropPosition = "before";
            } else {
                card.style.borderTop = "";
                card.style.borderBottom = "3px solid #4f8cff";
                card.dataset.dropPosition = "after";
            }
        }

        function handleDropOnCard(targetId, columnId, e) {
            if (dragTaskId === null || dragTaskId === targetId) return;

            const dragIdx = tasks.findIndex(t => t.id === dragTaskId);
            const targetIdx = tasks.findIndex(t => t.id === targetId);
            const dragged = tasks[dragIdx];

            const dropPosition = e.currentTarget.dataset.dropPosition || "before";

            // Remove da posi√ß√£o original
            tasks.splice(dragIdx, 1);

            // Corrige coluna
            dragged.column = columnId;

            // Novo √≠ndice de inser√ß√£o
            let insertIdx = targetIdx;
            if (dropPosition === "after") insertIdx++;

            // Corrige se arrastando para baixo na mesma coluna
            if (dragIdx < targetIdx && dropPosition === "after") insertIdx--;

            tasks.splice(insertIdx, 0, dragged);

            renderBoard();
        }

        // Limpa indicadores visuais de todos os cards
        function clearDropIndicators() {
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.style.borderTop = "";
                card.style.borderBottom = "";
                delete card.dataset.dropPosition;
            });
        }

        // Manipula o drop sobre um card espec√≠fico
        function handleDropOnCard(targetId, columnId, e) {
            if (dragTaskId === null || dragTaskId === targetId) return;
            const colTasks = tasks.filter(t => t.column === columnId);
            const dragIdx = tasks.findIndex(t => t.id === dragTaskId);
            const targetIdx = tasks.findIndex(t => t.id === targetId);
            const dropPosition = e.currentTarget.dataset.dropPosition;
            const dragged = tasks[dragIdx];
            // Remove da posi√ß√£o original
            tasks.splice(dragIdx, 1);
            // Calcula nova posi√ß√£o
            let insertIdx = targetIdx;
            if (dropPosition === "after") insertIdx++;
            // Se arrastando para baixo, ajustar √≠ndice
            if (dragIdx < targetIdx && dropPosition === "after") insertIdx--;
            // Atualiza coluna
            dragged.column = columnId;
            tasks.splice(insertIdx, 0, dragged);
            renderBoard();
        }

        // Permite soltar na coluna vazia (fim da coluna)
        window.onDropColumn = function(columnId) {
            if (dragTaskId !== null) {
                const dragIdx = tasks.findIndex(t => t.id === dragTaskId);
                const dragged = tasks[dragIdx];
                // Remove da posi√ß√£o original
                tasks.splice(dragIdx, 1);
                // Atualiza coluna
                dragged.column = columnId;
                // Adiciona ao final
                tasks.push(dragged);
                renderBoard();
            }
        };

        function addTask(event, columnId) {
            event.preventDefault();
            const input = event.target.querySelector('input');
            tasks.push({
                id: Date.now(),
                title: input.value,
                index: tasks.filter(t => t.column === columnId).length,
                column: columnId,
                x: 0,
                y: 0
            });
            input.value = '';
            renderBoard();
        }

        function editPossTask(id){
            var task = tasks.find(t => t.id === id);
            // Seleciona o card correspondente
            var div = document.querySelector(`.kanban-card[data-id="${id}"]`);
            var rect = div.getBoundingClientRect();
            task.x = rect.left;
            task.y = rect.top;
        }

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            const newTitle = prompt("Editar tarefa:", task.title);
            if (newTitle !== null) {
                task.title = newTitle;
                renderBoard();
            }
        }

        function removeTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderBoard();
        }

        function moveTask(id, direction) {
            const idx = tasks.findIndex(t => t.id === id);
            const colIdx = columns.findIndex(c => c.id === tasks[idx].column);
            const newColIdx = colIdx + direction;
            if (newColIdx >= 0 && newColIdx < columns.length) {
                tasks[idx].column = columns[newColIdx].id;
                tasks[idx].index = tasks.filter(t => t.column === columns[newColIdx].id).length;
                renderBoard();
            }
        }

        function onDragStart(id, card) {
            dragTaskId = id;
            card.classList.add('dragging');
        }

        function onDragEnd(card) {
            dragTaskId = null;
            card.classList.remove('dragging');
        }

        window.onDrop = function(columnId) {
            if (dragTaskId !== null) {
                const idx = tasks.findIndex(t => t.id === dragTaskId);
                tasks[idx].column = columnId;
                renderBoard();
            }
        };

        function moveTaskInColumn(dragId, targetId, columnId) {
            const dragIdx = tasks.findIndex(t => t.id === dragId && t.column === columnId);
            const targetIdx = tasks.findIndex(t => t.id === targetId && t.column === columnId);
            if (dragIdx === -1 || targetIdx === -1 || dragIdx === targetIdx) return;
            const [dragged] = tasks.splice(dragIdx, 1);
            tasks.splice(targetIdx, 0, dragged);
            renderBoard();
        }

        let editingTaskId = null;

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            editingTaskId = id;
            document.getElementById('editInput').value = task.title;
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingTaskId = null;
        }

        function saveEdit() {
            const newTitle = document.getElementById('editInput').value.trim();
            if (newTitle && editingTaskId !== null) {
                const task = tasks.find(t => t.id === editingTaskId);
                task.title = newTitle;
                renderBoard();
                closeEditModal();
            }
        }

        window.addTask = addTask;
        window.removeTask = removeTask;
        window.moveTask = moveTask;

        renderBoard();
    </script>
</body>
</html>